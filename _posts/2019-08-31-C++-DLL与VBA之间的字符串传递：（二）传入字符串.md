---
layout: post
author: Train
description: VBA与DLL参数传递：String
keywords: VBA, Excel, dll
tags: [VBA, C++]
---

以`upper_bstr()`和`upper_vba_bstr()`为例，无论VBA函数还是Excel公式，最终都是通过`upper_bstr()`与C++连接，C++代码中统一用`char*`接收，但结果却存在上述差异。由此可见，**VBA宏代码和Excel公式中传递字符串参数的编码方式略有不同**。进一步了解可知，Excel公式以`Unicode数组`格式传递字符串，VBA则以`ANSI数组`方式传递和显示字符串。还有重要的一点是，单元格中的`Unicode`字符串传入VBA函数中会自动进行`ANSI`编码转换。

因此，VBA版本和C++接口版本在Excel公式中的参数传递

本文的C++函数以`char*`接收字符串，可以正确解析VBA传入的`ANSI`字符串，却无法正确识别Excel公式中的`Unicode`字符串。而`SysAllocStringByteLen()`函数返回的`BSTR`恰好对应了`ANSI`字符串，因此可以正确为VBA所识别。


